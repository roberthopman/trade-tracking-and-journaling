<% content_for :title, "New Trade" %>

<div class="header">
  <h1>New Trade</h1>
</div>

<div class="bg-white rounded-lg shadow p-6" data-controller="trade-form">
  <%= form_with model: @record, url: madmin_trades_path, local: true do |form| %>

    <% if @record.errors.any? %>
      <div class="bg-red-50 border border-red-200 text-red-800 rounded-md p-4 mb-6">
        <h3 class="font-medium mb-2">
          <%= pluralize(@record.errors.count, "error") %>
          prohibited this trade from being saved:
        </h3>
        <ul class="list-disc list-inside">
          <% @record.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Required Fields Section -->
    <div class="mb-8">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Required Information</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Account (First) -->
        <div class="field md:col-span-2">
          <%= form.label :account_id,
                "Account",
                class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.collection_select :account_id,
                current_user.accounts.real_accounts.order(:firm_id, :name),
                :id,
                :to_s,
                {prompt: "Select account"},
                {
                  required: true,
                  class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                         "focus:outline-none focus:ring-2 focus:ring-blue-500"
                } %>
        </div>

        <!-- Trade Date -->
        <div class="field">
          <%= form.label :trade_date,
                "Trade Date",
                class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.date_field :trade_date,
                value: @record.trade_date || Date.current,
                required: true,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Symbol -->
        <div class="field">
          <%= form.label :symbol,
                "Symbol",
                class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.text_field :symbol,
                required: true,
                placeholder: "e.g., EURUSD, NAS100",
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- P&L -->
        <div class="field">
          <%= form.label :pnl,
                "P&L",
                class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.number_field :pnl,
                step: 0.01,
                required: true,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Auto Liquidity Threshold -->
        <div class="field">
          <%= label_tag :auto_liquidity_threshold,
                "Auto Liquidity Threshold",
                class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= number_field_tag :auto_liquidity_threshold,
                @record.account&.auto_liquidity_threshold,
                step: 0.01,
                autocomplete: "off",
                placeholder: "Optional threshold value",
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Trade Type -->
        <div class="field">
          <%= form.label :trade_type,
                "Trade Type",
                class: "block text-sm font-medium text-gray-700 mb-1" %>
          <div class="flex gap-4 mt-2">
            <% Trade::TRADE_TYPES.each do |value, label| %>
              <label class="flex items-center">
                <%= form.radio_button :trade_type, value, class: "mr-2" %>
                <span class="text-sm text-gray-700"><%= label %></span>
              </label>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Tags Input -->
    <div class="mb-6"
      data-controller="tag-input"
      data-tag-input-tags-value="<%= begin
                                       @trade.tags.pluck(:name)
                                     rescue
                                       []
                                     end.to_json %>"
      data-tag-input-available-value="<%= current_user.tags.joins(:trades).distinct.pluck(:name).to_json %>">
      <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
      <div class="flex flex-wrap gap-2 mb-2" data-tag-input-target="tagsList"></div>
      <div class="mb-2" data-tag-input-target="suggestions"></div>
      <input type="text"
             data-tag-input-target="input"
             data-action="keydown->tag-input#addTag"
             placeholder="Type a tag and press Enter or comma"
             autocomplete="off"
             class="w-full px-3 py-2 border border-gray-300 rounded-md
               focus:outline-none focus:ring-2 focus:ring-blue-500">
      <input type="hidden"
        name="trade[tag_list]"
        data-tag-input-target="hiddenInput">
      <p class="text-xs text-gray-500 mt-1">
        Press Enter or comma to add a tag, or click an existing tag above
      </p>
    </div>

    <!-- Optional Fields Toggle -->
    <div class="mb-6 border-t border-gray-200 pt-6">
      <button type="button"
              data-action="click->trade-form#toggleOptional"
              class="flex items-center justify-between w-full text-left">
        <h2 class="text-lg font-semibold text-gray-900">Optional Fields</h2>
        <svg data-trade-form-target="toggleIcon"
          class="w-5 h-5 transform transition-transform"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 9l-7 7-7-7" />
        </svg>
      </button>
    </div>

    <!-- Optional Fields Section (Hidden by default) -->
    <div data-trade-form-target="optionalFields" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Quantity -->
        <div class="field">
          <%= form.label :volume,
                "Quantity",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.number_field :volume,
                step: 0.01,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Entry Price -->
        <div class="field">
          <%= form.label :entry_price,
                "Entry Price",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.number_field :entry_price,
                step: 0.00001,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Exit Price -->
        <div class="field">
          <%= form.label :exit_price,
                "Exit Price",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.number_field :exit_price,
                step: 0.00001,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Stop Loss -->
        <div class="field">
          <%= form.label :stop_loss,
                "Stop Loss",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.number_field :stop_loss,
                step: 0.00001,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Take Profit -->
        <div class="field">
          <%= form.label :take_profit,
                "Take Profit",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.number_field :take_profit,
                step: 0.00001,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Entry Time -->
        <div class="field">
          <%= form.label :entry_time,
                "Entry Time",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.datetime_local_field :entry_time,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Exit Time -->
        <div class="field">
          <%= form.label :exit_time,
                "Exit Time",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.datetime_local_field :exit_time,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Commission -->
        <div class="field">
          <%= form.label :commission,
                "Commission",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.number_field :commission,
                step: 0.01,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Swap -->
        <div class="field">
          <%= form.label :swap,
                "Swap",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.number_field :swap,
                step: 0.01,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Strategy -->
        <div class="field">
          <%= form.label :strategy,
                "Strategy",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_field :strategy,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Market -->
        <div class="field">
          <%= form.label :market,
                "Market",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_field :market,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Setup -->
        <div class="field md:col-span-2">
          <%= form.label :setup,
                "Setup",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_area :setup,
                rows: 3,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Emotional State -->
        <div class="field">
          <%= form.label :emotional_state,
                "Emotional State",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_field :emotional_state,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Market Condition -->
        <div class="field">
          <%= form.label :market_condition,
                "Market Condition",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_field :market_condition,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Trade Grade -->
        <div class="field">
          <%= form.label :trade_grade,
                "Trade Grade",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_field :trade_grade,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- External Trade ID -->
        <div class="field md:col-span-2">
          <%= form.label :external_trade_id,
                "External Trade ID",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_field :external_trade_id,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Notes -->
        <div class="field md:col-span-2">
          <%= form.label :notes,
                "Notes",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_area :notes,
                rows: 3,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>

        <!-- Lesson Learned -->
        <div class="field md:col-span-2">
          <%= form.label :lesson_learned,
                "Lesson Learned",
                class: "block text-sm font-medium text-gray-600 mb-1" %>
          <%= form.text_area :lesson_learned,
                rows: 3,
                class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                       "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-200 mt-6">
      <%= link_to "Cancel", madmin_trades_path, class: "btn btn-secondary" %>
      <%= form.submit "Create Trade", class: "btn btn-primary" %>
    </div>

  <% end %>
</div>
