<div class="rules-section" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
  <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">Account Rules</h3>

  <% trading_rules = Rule.active.trading_rules.order(:sort_order) %>
  <% trading_restrictions = Rule.active.trading_restrictions.order(:sort_order) %>
  <% payout_rules = Rule.active.payout_rules.order(:sort_order) %>
  <% payout_restrictions = Rule.active.payout_restrictions.order(:sort_order) %>

  <!-- Trading Rules Section -->
  <div class="rules-group" style="margin-bottom: 2rem;">
    <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Trading Rules</h4>
    <div class="grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
      <% rule_defaults = {
           "Daily Loss Limit ($)" => "2000",
           "Max Total Loss ($)" => "4000",
           "Profit Target (%)" => "10",
           "Min Trading Days" => "10",
           "Min Trading Day Amount ($)" => "100",
           "Consistency Rule (%)" => "30",
           "Safety Net (%)" => "2",
           "Max Position Size (%)" => "100",
           "Leverage Limit" => "100",
           "Phase 1 Target (%)" => "8",
           "Safety Net ($)" => "200",
           "Profit Target ($)" => "1000"
         } %>
      <% trading_rules.each do |rule| %>
        <% existing_rule = form.object.account_rules.find { |ar| ar.rule_id == rule.id } %>
        <% default_value = existing_rule&.rule_value || rule_defaults[rule.name] %>
        <%= form.fields_for :account_rules,
              existing_rule || form.object.account_rules.build(
                rule: rule,
                start_date: Date.current,
                rule_value: default_value
              ) do |rule_form| %>
          <%= rule_form.hidden_field :rule_id, value: rule.id %>
          <%= rule_form.hidden_field :start_date, value: Date.current %>
          <div class="field">
            <%= rule_form.label :rule_value,
                  rule.name,
                  class: "block text-sm font-medium text-gray-700 mb-1" %>
            <% if rule.data_type == "boolean_flag" %>
              <%= rule_form.check_box :rule_value, class: "rounded border-gray-300" %>
            <% else %>
              <% input_placeholder = if rule.data_type == "percentage"
                                       "0-100"
                                     elsif rule.data_type == "currency_amount"
                                       "$"
                                     else
                                       "Enter value"
                                     end %>
              <% input_class = "w-full px-3 py-2 border border-gray-300 rounded-md " \
                               "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
              <% field_value = rule_form.object.rule_value.presence || default_value %>
              <%= rule_form.text_field :rule_value,
                    value: field_value,
                    placeholder: input_placeholder,
                    class: input_class,
                    required: rule.sort_order.between?(1, 11) %>
            <% end %>
            <% if rule.description.present? %>
              <p class="mt-1 text-xs text-gray-500"><%= rule.description %></p>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Trading Restrictions Section -->
  <div class="rules-group" style="margin-bottom: 2rem;">
    <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Trading Restrictions</h4>
    <div class="grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
      <% trading_restrictions.each do |rule| %>
        <% existing_rule = form.object.account_rules.find { |ar| ar.rule_id == rule.id } %>
        <% default_boolean = existing_rule&.rule_value || "true" %>
        <%= form.fields_for :account_rules,
              existing_rule || form.object.account_rules.build(
                rule: rule,
                start_date: Date.current,
                rule_value: default_boolean
              ) do |rule_form| %>
          <%= rule_form.hidden_field :rule_id, value: rule.id %>
          <%= rule_form.hidden_field :start_date, value: Date.current %>
          <div class="field">
            <%= rule_form.label :rule_value,
                  rule.name,
                  class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= rule_form.select :rule_value,
                  [["Allowed", "true"], ["Not Allowed", "false"]],
                  {},
                  class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                         "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
            <% if rule.description.present? %>
              <p class="mt-1 text-xs text-gray-500"><%= rule.description %></p>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Payout Rules Section -->
  <div class="rules-group" style="margin-bottom: 2rem;">
    <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Payout Rules</h4>
    <div class="grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
      <% payout_rules.each do |rule| %>
        <% existing_rule = form.object.account_rules.find { |ar| ar.rule_id == rule.id } %>
        <%= form.fields_for :account_rules,
              existing_rule || form.object.account_rules.build(rule: rule, start_date: Date.current) do |rule_form| %>
          <%= rule_form.hidden_field :rule_id, value: rule.id %>
          <%= rule_form.hidden_field :start_date, value: Date.current %>
          <div class="field">
            <%= rule_form.label :rule_value,
                  rule.name,
                  class: "block text-sm font-medium text-gray-700 mb-1" %>
            <% payout_placeholder = if rule.data_type == "percentage"
                                      "0-100"
                                    elsif rule.data_type == "currency_amount"
                                      "$"
                                    else
                                      "Days"
                                    end %>
            <% input_class = "w-full px-3 py-2 border border-gray-300 rounded-md " \
                             "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
            <%= rule_form.text_field :rule_value,
                  placeholder: payout_placeholder,
                  class: input_class %>
            <% if rule.description.present? %>
              <p class="mt-1 text-xs text-gray-500"><%= rule.description %></p>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Payout Restrictions Section -->
  <div class="rules-group">
    <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Payout Restrictions</h4>
    <div class="grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
      <% payout_restrictions.each do |rule| %>
        <% existing_rule = form.object.account_rules.find { |ar| ar.rule_id == rule.id } %>
        <% default_boolean = existing_rule&.rule_value || "true" %>
        <%= form.fields_for :account_rules,
              existing_rule || form.object.account_rules.build(
                rule: rule,
                start_date: Date.current,
                rule_value: default_boolean
              ) do |rule_form| %>
          <%= rule_form.hidden_field :rule_id, value: rule.id %>
          <%= rule_form.hidden_field :start_date, value: Date.current %>
          <div class="field">
            <%= rule_form.label :rule_value,
                  rule.name,
                  class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= rule_form.select :rule_value,
                  [["Required", "true"], ["Not Required", "false"]],
                  {},
                  class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                         "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
            <% if rule.description.present? %>
              <p class="mt-1 text-xs text-gray-500"><%= rule.description %></p>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
