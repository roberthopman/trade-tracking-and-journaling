<% content_for :title, "Accounts" %>

<div class="mb-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold text-gray-900">Accounts</h1>
    <div class="flex gap-2">
      <%= link_to "New Account", new_madmin_account_path, class: "btn btn-primary" %>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-lg shadow p-4 mb-4">
    <%= form_with url: madmin_accounts_path,
          method: :get,
          local: true,
          class: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" do |f| %>
      <div>
        <%= label_tag :firm_id,
              "Firm",
              class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= select_tag :firm_id,
              options_from_collection_for_select(
                Firm.active.order(:name), :id, :name, params[:firm_id]
              ),
              prompt: "All Firms",
              class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                     "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>

      <div>
        <%= label_tag :phase,
              "Stage",
              class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= select_tag :phase,
              options_for_select(
                Account::PHASES.map { |phase| [phase.titleize, phase] },
                params[:phase]
              ),
              prompt: "All Stages",
              class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                     "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>

      <div>
        <%= label_tag :status,
              "Status",
              class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= select_tag :status,
              options_for_select(
                Account::STATUSES.map { |status| [status.titleize, status] },
                params[:status]
              ),
              prompt: "All Statuses",
              class: "w-full px-3 py-2 border border-gray-300 rounded-md " \
                     "focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      </div>

      <div class="flex items-end gap-2">
        <%= submit_tag "Filter", class: "btn btn-primary" %>
        <%= link_to "Clear", madmin_accounts_path, class: "btn btn-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Accounts Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
  <table class="w-full">
    <thead class="bg-gray-50 border-b border-gray-200">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Account
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Details
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Status
        </th>
        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
          Size
        </th>
        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
          Balance
        </th>
        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
          P&L
        </th>
        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
          Available DD
        </th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Actions
        </th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      <% if @records.any? %>
        <% @records.each do |account| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= link_to madmin_account_path(account),
                    class: "text-blue-600 hover:text-blue-800 font-medium" do %>
                <div><%= account.firm.name %></div>
                <div class="text-xs text-gray-500"><%= account.to_s %></div>
              <% end %>
            </td>
            <td class="px-6 py-4">
              <div class="space-y-1">
                <div class="text-sm text-gray-900">
                  <%= account.phase_display_name %>
                </div>
                <% if account.connection.present? || account.platform.present? %>
                  <div class="text-xs text-gray-500">
                    <%= [account.connection, account.platform].compact.join(" • ") %>
                  </div>
                <% end %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= account.status.titleize %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
              <%= number_to_currency(account.initial_balance, precision: 2) %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
              <%= number_to_currency(account.current_balance, precision: 2) %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-right
              <%= account.profit_loss >= 0 ? "text-green-600" : "text-red-600" %>">
              <%= number_to_currency(account.profit_loss, precision: 2) %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium
              <%= if account.available_drawdown
                    account.available_drawdown >= 0 ? "text-green-600" : "text-red-600"
                  else
                    "text-gray-400"
                  end %>">
              <% if account.available_drawdown %>
                <%= number_to_currency(account.available_drawdown, precision: 2) %>
              <% else %>
                —
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex gap-2">
                <%= link_to "View",
                      madmin_account_path(account),
                      class: "text-blue-600 hover:text-blue-800" %>
                <%= link_to "Edit",
                      edit_madmin_account_path(account),
                      class: "text-indigo-600 hover:text-indigo-800" %>
              </div>
            </td>
          </tr>
        <% end %>
      <% else %>
        <tr>
          <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">
            No accounts found
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- Pagination -->
<% if defined?(@pagy) && @pagy.pages > 1 %>
  <div class="mt-6 flex justify-center">
    <%== pagy_nav(@pagy) if @pagy.pages > 1 %>
  </div>
<% end %>
